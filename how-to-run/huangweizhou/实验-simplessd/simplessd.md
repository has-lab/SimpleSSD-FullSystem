
# Simplessd-Fullsystem 学习笔记
## 准备
Create directory to store downloaded files and set M5_PATH environment variable points that directory.

- mkdir $HOME/m5
- export M5_PATH=$HOME/m5


As we will boot gem5 in full system simulation mode, we need full system files such as Linux Kernel image and disk image. If you want to download original gem5-provided full system files, visit [gem5 download page](http://www.gem5.org/documentation/general_docs/fullsystem/guest_binaries#manual-download). **We recommend to download files from [here](https://drive.google.com/drive/folders/14b-kJmGXOhltX9Aqr8XV9i48KkZk4Lzs)**, because the files from gem5 does not support NVMe. You don’t need to download kernel_configs directory if you are not plan to build Linux Kernel on your own.

you can use winscp to transfer downloaded files to the server,and use unzip commands to unzip files:

- unzip test.zip




## 下载
- git clone https://github.com/SimpleSSD/SimpleSSD-FullSystem.git
- cd simplessd-fullsystem
- git submodule update --init --recursive

## 编译 
for x86:

scons build/X86/gem5.opt -j 64 --ignore-style  


## 仿真器配置 

### gem5
<center>
<img src="./utility.png" width="95%" height="65%" />


</center>

### simplessd
src/dev/storage/simplessd/config/sample.cfg






## 运行

./build/X86/gem5.opt --debug-flag=M5Print --debug-file=debug.txt ./configs/example/fs.--py --kernel=x86_64-vmlinux-4.9.92 --num-cpu=4 --cpu-clock=2GHz --caches --l2cache --cpu-type=AtomicSimpleCPU --mem-size=16GB --mem-type=DDR4_2400_8x8 --ssd-interface=nvme --ssd-config=./src/dev/storage/simplessd/config/sample.cfg


### 参数选择
simplessd 配置文件：
./src/dev/storage/simplessd/config/sample.cfg


## 结果分析
For SimpleSSD-FullSystem, you can find statistics at m5out/stats.txt. This stats.txt file is generated by gem5, which can controlled in user-level space through m5 utility.
## 与GEM5交互
通过SST模块：
SST (Structural Simulation Toolkit, sst-simulator.org). More
specifically, it creates a .so that wraps the libgem5_*.so library. At a
high level, this allows memory traffic to pass between the two simulators.
## 代码定位：
### ssd
src/dev/storage/simplessd
#### 模块
- hil(接口) 
- icl（缓存） 
- ftl（GC，地址映射等） 
- pal（物理介质并行管理）

<center>
<img src="./simplessd.png" width="95%" height="65%" />


</center>


##### BAR

src/dev/pci/device.hh
<center>
<img src="./PCI_BAR调用栈.png" width=1200 height=500 />

到SSD BAR配置为止的软件栈

</center>



- /home/nvm/huangweizhou/SimpleSSD-FullSystem/build/X86/dev/storage/NVMe.py
<center>
<img src="./pcidev.png" width=800% height=200% />

pci配置空间 command寄存器配置
</center>


## 程序入口：

 - m5Main (argc=<optimized out>, _argv=<optimized out>) at build/X86/sim/init.cc:302
 - main (argc=14, argv=0x7fffffffddc8) at build/X86/sim/main.cc:69


<center>
<img src="./simplessd入口.png" width="95%" height="65%" />

程序入口软件栈
</center>

## 线程执行逻辑
These threads start by waiting on threadBarrier.  **Once all threads have arrived at threadBarrier, they enter the simulation loop concurrently**.  When they exit the loop, they return to waiting on threadBarrier